<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>IVAO Radar Map Inspired by vatsim-radar.com</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  html, body, #map {
    height: 100%;
    margin: 0; padding: 0;
    background-color: #121212;
    color: white;
  }
  .leaflet-popup-content-wrapper {
    background: #222;
    color: white;
    font-family: Arial, sans-serif;
  }
  .atc-badge {
    font-weight: bold;
    border-radius: 3px;
    padding: 1px 5px;
    margin-right: 5px;
    font-size: 12px;
    display: inline-block;
    vertical-align: middle;
    color: white;
  }
  .badge-tower { background: #c0392b; }  /* red */
  .badge-ground { background: #27ae60; } /* green */
  .badge-delivery { background: #2980b9; } /* blue */
  #map {
    filter: brightness(0.9);
  }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([51.41779, 1.99934], 7);

// Dark basemap from CartoDB
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap &copy; CartoDB',
}).addTo(map);

// Placeholder token server and API URLs
const TOKEN_SERVER = 'https://ivao-token-server.onrender.com/token';
const IVAO_API = 'https://api.ivao.aero/v2/tracker/whazzup';

// Map layers to hold markers
const atcLayer = L.layerGroup().addTo(map);
const aircraftLayer = L.layerGroup().addTo(map);

// Custom icon for controllers with badges
function atcIcon(controller) {
  let badgeClass = '';
  let badgeLetter = '';
  if (controller.facility === 'ATC_TWR') {
    badgeClass = 'badge-tower';
    badgeLetter = 'T';
  } else if (controller.facility === 'ATC_GND') {
    badgeClass = 'badge-ground';
    badgeLetter = 'G';
  } else if (controller.facility === 'ATC_DEL') {
    badgeClass = 'badge-delivery';
    badgeLetter = 'D';
  } else {
    badgeClass = 'badge-tower';
    badgeLetter = '?';
  }
  const html = `<div class="atc-badge ${badgeClass}">${badgeLetter}</div><span style="color:white;">${controller.callsign}</span>`;
  return L.divIcon({
    html,
    className: '',
    iconSize: [40, 20],
    iconAnchor: [20, 10],
    popupAnchor: [0, -10]
  });
}

// Custom icon for aircraft - simple colored circle with callsign label
function aircraftIcon() {
  return L.divIcon({
    html: `<div style="
      width: 16px; height: 16px; border-radius: 50%; background: #f39c12; border: 2px solid #e67e22;
      box-shadow: 0 0 5px #f39c12;
    "></div>`,
    className: '',
    iconSize: [16, 16],
    iconAnchor: [8, 8],
    popupAnchor: [0, -10]
  });
}

// Fetch token from your token server
async function getToken() {
  try {
    const res = await fetch(TOKEN_SERVER);
    if (!res.ok) throw new Error('Token fetch failed');
    const data = await res.json();
    if (!data.token) throw new Error('No token in response');
    return data.token;
  } catch(e) {
    console.error('Token error:', e);
    return null;
  }
}

// Fetch IVAO data using token
async function fetchIVAO(token) {
  if (!token) return null;
  try {
    const res = await fetch(IVAO_API, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error('IVAO API error');
    const data = await res.json();
    return data;
  } catch(e) {
    console.error('Fetch IVAO error:', e);
    return null;
  }
}

// Update map markers
async function updateMap() {
  const token = await getToken();
  if (!token) return;

  const data = await fetchIVAO(token);
  if (!data || !data.clients) return;

  atcLayer.clearLayers();
  aircraftLayer.clearLayers();

  // Add controllers
  (data.clients.controllers || []).forEach(ctrl => {
    if (!ctrl.position) return;
    const marker = L.marker([ctrl.position.lat, ctrl.position.lon], { icon: atcIcon(ctrl) });
    const popupContent = `
      <strong>${ctrl.callsign}</strong><br/>
      Position: ${ctrl.position.name || 'N/A'}<br/>
      Frequency: ${ctrl.frequency || 'N/A'}
    `;
    marker.bindPopup(popupContent);
    atcLayer.addLayer(marker);
  });

  // Add aircraft
  (data.clients.pilots || []).forEach(ac => {
    if (!ac.position) return;
    const marker = L.marker([ac.position.lat, ac.position.lon], { icon: aircraftIcon() });
    const popupContent = `
      <strong>${ac.callsign}</strong><br/>
      Aircraft: ${ac.flightPlan?.aircraftId || 'N/A'}<br/>
      Departure: ${ac.flightPlan?.departureId || 'N/A'}<br/>
      Arrival: ${ac.flightPlan?.arrivalId || 'N/A'}<br/>
      Altitude: ${ac.position.altitude || 'N/A'} ft<br/>
      Groundspeed: ${ac.position.groundspeed || 'N/A'} kts
    `;
    marker.bindPopup(popupContent);
    aircraftLayer.addLayer(marker);
  });

  // TODO: Add airspace boundaries and radar sectors here, using GeoJSON overlays
}

// Initial load + refresh every 30 seconds
updateMap();
setInterval(updateMap, 30000);
</script>
</body>
</html>
